"""
–ë–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –∏ –ø—Ä–µ—Å–µ—Ç—ã.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —à–∞–±–ª–æ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ ~/.life_timer/templates.json
"""

BUILTIN_TEMPLATES = [
    # category, name, minutes
    ("üåô –°–æ–Ω –∏ –æ—Ç–¥—ã—Ö",   "–°–æ–Ω",              480),
    ("üåô –°–æ–Ω –∏ –æ—Ç–¥—ã—Ö",   "–î–Ω–µ–≤–Ω–æ–π —Å–æ–Ω",       30),
    ("üöø –ì–∏–≥–∏–µ–Ω–∞",       "–£—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—ã",  30),
    ("üöø –ì–∏–≥–∏–µ–Ω–∞",       "–í–µ—á–µ—Ä–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—ã",  20),
    ("üç≥ –ï–¥–∞",           "–ó–∞–≤—Ç—Ä–∞–∫",           20),
    ("üç≥ –ï–¥–∞",           "–û–±–µ–¥",              30),
    ("üç≥ –ï–¥–∞",           "–£–∂–∏–Ω",              30),
    ("üç≥ –ï–¥–∞",           "–ì–æ—Ç–æ–≤–∫–∞",           45),
    ("üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",    "–ó–∞—Ä—è–¥–∫–∞",           15),
    ("üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",    "–°–ø–æ—Ä—Ç",             60),
    ("üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",    "–ü—Ä–æ–≥—É–ª–∫–∞",          45),
    ("üßò –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–µ",    "–ú–µ–¥–∏—Ç–∞—Ü–∏—è",         15),
    ("üßò –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–µ",    "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω—è",  15),
    ("üßò –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–µ",    "–î–Ω–µ–≤–Ω–∏–∫",           15),
    ("üè† –ë—ã—Ç",           "–£–±–æ—Ä–∫–∞",            30),
    ("üè† –ë—ã—Ç",           "–ü–æ–∫—É–ø–∫–∏",           45),
]

BUILTIN_PRESETS = {
    "üíº –†–∞–±–æ—á–∏–π –¥–µ–Ω—å": [
        "–°–æ–Ω", "–£—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—ã", "–ó–∞–≤—Ç—Ä–∞–∫",
        "–û–±–µ–¥", "–£–∂–∏–Ω", "–í–µ—á–µ—Ä–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—ã",
    ],
    "üõã –í—ã—Ö–æ–¥–Ω–æ–π": [
        "–°–æ–Ω", "–£—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—ã", "–ó–∞–≤—Ç—Ä–∞–∫",
        "–ü—Ä–æ–≥—É–ª–∫–∞", "–û–±–µ–¥", "–î–Ω–µ–≤–Ω–æ–π —Å–æ–Ω",
        "–£–∂–∏–Ω", "–í–µ—á–µ—Ä–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—ã",
    ],
}

CATEGORIES = list(dict.fromkeys(t[0] for t in BUILTIN_TEMPLATES))


def get_all_templates(user_templates: list[dict]) -> dict[str, list[dict]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —à–∞–±–ª–æ–Ω—ã, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
    –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ.
    """
    grouped: dict[str, list[dict]] = {cat: [] for cat in CATEGORIES}
    grouped["üë§ –ú–æ–∏ —à–∞–±–ª–æ–Ω—ã"] = []

    for cat, name, minutes in BUILTIN_TEMPLATES:
        grouped[cat].append({
            "name": name,
            "allocated_seconds": minutes * 60,
            "category": cat,
            "builtin": True,
        })

    for t in user_templates:
        cat = t.get("category", "üë§ –ú–æ–∏ —à–∞–±–ª–æ–Ω—ã")
        if cat not in grouped:
            grouped[cat] = []
        grouped[cat].append({**t, "builtin": False})

    # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    return {k: v for k, v in grouped.items() if v}


def resolve_preset(preset_name: str, user_templates: list[dict]) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –ø—Ä–µ—Å–µ—Ç–∞."""
    all_templates = get_all_templates(user_templates)
    flat = {t["name"]: t for group in all_templates.values() for t in group}

    names = BUILTIN_PRESETS.get(preset_name, [])
    return [flat[n] for n in names if n in flat]
